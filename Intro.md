

<div dir="rtl" align="right">

# کتاب آشپزی همزمانی در C#، ویرایش دوم

**نویسنده:** استیون کلیری  
**کلیه حقوق متعلق به استیون کلیری، © ۲۰۱۹**  
**چاپ شده در ایالات متحده آمریکا**  
**منتشر شده توسط انتشارات O’Reilly Media, Inc.**  
۱۰۵ خیابان گریونستین شمالی، سباستاپول، کالیفرنیا، ۹۵۴۷۲

کتاب‌های O’Reilly ممکن است برای مصارف آموزشی، تجاری یا تبلیغات فروش تهیه شوند. نسخه‌های آنلاین نیز برای بیشتر عناوین موجود است ([http://oreilly.com](http://oreilly.com)).  
برای اطلاعات بیشتر با بخش فروش شرکت/سازمان: ۹۹۳۸-۹۹۸-۸۰۰ یا corporate@oreilly.com تماس حاصل فرمایید.

**سردبیر جذب:** کریس گوزیکوفسکی  
**سردبیر توسعه:** کوربین کالینز  
**سردبیر تولید:** دب بیکر  
**ویراستار:** آماندا کرسی  
**ویراستار نهایی:** سونیا ساروبا  
**نمایه‌ساز:** آنجلا هاوارد  
**طراح داخلی:** دیوید فوتاتو  
**طراح جلد:** رندی کومر  
**تصویرگر:** ربکا دمارست

ژوئن ۲۰۱۴: ویرایش اول  
آگوست ۲۰۱۹: ویرایش دوم  

**تاریخچه‌ی بازبینی برای ویرایش دوم:**  
۲۰۱۹-۰۸-۲۰: نخستین انتشار

جزئیات انتشار را در [http://oreilly.com/catalog/errata.csp?isbn=9781492054504](http://oreilly.com/catalog/errata.csp?isbn=9781492054504) مشاهده کنید.

لوگوی O’Reilly یک علامت تجاری ثبت‌شده متعلق به O’Reilly Media, Inc است.  
کتاب "آشپزی همزمانی در C# ـ ویرایش دوم"، تصویر روی جلد و سایر نشانه‌های تجاری مرتبط، متعلق به O’Reilly Media, Inc می‌باشد.

دیدگاه‌های مطرح شده در این اثر تنها متعلق به نویسنده است و الزاما نماینده‌ی نظرات ناشر نیست. هر چند ناشر و نویسنده با حسن نیت تلاش کرده‌اند که اطلاعات و دستورالعمل‌های این اثر دقیق باشد، ولی مسئولیتی در قبال خطاها یا حذف‌ها، شامل ـ اما نه محدود به ـ خسارات ناشی از استفاده یا اتکا به این اثر پذیرفته نمی‌شود. استفاده از اطلاعات و دستورالعمل‌های این کتاب به عهده خود شماست. اگر نمونه‌ کد یا فناوری دیگری که در این اثر آورده یا توصیف شده است، مشمول پروانه‌های منبع باز یا حقوق مالکیت دیگران باشد، اطمینان از تطابق استفاده شما با آن پروانه‌ها و حقوق، بر عهده خودتان است.

۹۷۸-۱-۴۹۲-۰۵۴۵۰-۴

---

# پیشگفتار

فکر می‌کنم حیوان روی جلد این کتاب ـ سیوت پالم معمولی ـ برای موضوع این کتاب بی‌ارتباط نیست. خودم تا زمانی که جلد کتاب را ندیده بودم چیزی درباره‌ی این حیوان نمی‌دانستم، بنابراین کمی جست‌وجو کردم. سیوت پالم‌های معمولی به عنوان آفت‌ها شناخته می‌شوند، چون در اتاقک‌های زیر شیروانی مدفوع می‌کنند و اغلب در بدترین زمان‌ها با سر و صدای زیاد با هم می‌جنگند. غدد بویایی مقعد آن‌ها ترشح بسیار بدبویی دارد. درجه‌ حفاظت از این گونه «کم‌خطر» است؛ که ظاهراً به زبان درست سیاسی یعنی "هر چه‌قدر می‌خواهید بکشید؛ کسی دلتنگ‌‌شان نمی‌شود". این حیوانات از خوردن گیلاس قهوه لذت می‌برند و دانه‌های قهوه را عبور می‌دهند. قهوه "کوپی لواک"، که از گران‌ترین قهوه‌های جهان محسوب می‌شود، از دانه‌هایی تهیه می‌شود که از مدفوع آن‌ها استخراج می‌کنند. به گفته انجمن قهوه تخصصی آمریکا: «طعمی واقعاً بد دارد.»

این خصوصیات باعث می‌شود سیوت پالم معمولی نماد مناسبی برای توسعه همزمان و چندریسمانی (مولتی‌تردینگ) باشد. برای کسانی که آشنا نیستند، همزمانی و چندریسمانی چیزهای نامطلوبی به نظر می‌رسد. این مفاهیم باعث می‌شوند کدی که درست کار می‌کند، به بدترین شکل رفتار کند. شرایط رقابتی و موارد مشابه باعث سقوط‌های احساسی می‌شوند (معمولاً، به نظر می‌رسد، یا در مرحله تولید یا هنگام نمایش!). برخی تا جایی پیش رفته‌اند که گفته‌اند «تردها اهریمنند» و کلاً سراغ همزمانی نمی‌روند. تعداد کمی از توسعه‌دهندگان هستند که به همزمانی علاقه‌مندند و بدون ترس از آن استفاده می‌کنند؛ اما اکثر برنامه‌نویسان قبلاً از همزمانی آسیب دیده‌اند و این تجربه، مزه تلخی برایشان به جا گذاشته است.

با این حال، برای برنامه‌های مدرن، همزمانی به سرعت به یک ضرورت بدل شده است. امروزه کاربران انتظار دارند رابط کاربری کاملاً پاسخگو باشد و برنامه‌های سروری باید در مقیاس‌هایی بی‌سابقه اجرا شوند. همزمانی پاسخ‌گوی هر دو روند است.

خوشبختانه، کتابخانه‌های مدرنی هستند که همزمانی را بسیار ساده‌تر کرده‌اند! پردازش موازی و برنامه‌نویسی ناهمگام دیگر فقط برای جادوگران نیستند. با بالا بردن سطح انتزاع، این کتابخانه‌ها توسعه برنامه‌های پاسخگو و مقیاس‌پذیر را برای هر توسعه‌دهنده، به هدفی واقع‌بینانه بدل کرده‌اند. اگر از همزمانی در گذشته ضربه خورده‌اید ـ زمانی که بسیار دشوار بود ـ تشویق‌تان می‌کنم با ابزارهای مدرن دوباره امتحانش کنید. شاید هرگز نتوانیم بگوییم که همزمانی آسان است، اما مطمئناً دیگر به سختی گذشته نیست!

---

## مخاطبان این کتاب

این کتاب برای توسعه‌دهندگانی نوشته شده است که می‌خواهند رویکردهای مدرن همزمانی را یاد بگیرند. فرض می‌کنم که تجربه‌ی مناسبی از .NET دارید، شامل آشنایی با کالکشن‌های جنریک، مقادیر enumerable و LINQ. انتظار ندارم تجربه‌ای از برنامه‌نویسی چندریسمانی یا ناهمگام داشته باشید. اگر هم تا حدودی با این زمینه‌ها آشنا هستید، باز هم این کتاب می‌تواند مفید باشد، چون کتابخانه‌های جدیدتری معرفی می‌کند که امن‌تر و راحت‌تر هستند.

همزمانی برای هر نوع برنامه‌ای مفید است. فرقی نمی‌کند که روی برنامه دسکتاپ، موبایل یا سرور کار می‌کنید؛ این روزها همزمانی عملاً یک الزام است. می‌توانید با استفاده از دستورالعمل‌های این کتاب، رابط‌های کاربری را پاسخگوتر و سرورها را مقیاس‌پذیرتر کنید. ما عملاً به جایی رسیده‌ایم که همزمانی فراگیر شده، و درک این تکنیک‌ها و کاربردهایشان دانشی اساسی برای یک توسعه‌دهنده حرفه‌ای است.

---

## چرا این کتاب را نوشتم

اوایل کارم، چندریسمانی را به سخت‌ترین شکل یاد گرفتم. بعد از چند سال، برنامه‌نویسی ناهمگام را هم با سختی یاد گرفتم. این تجربیات بسیار باارزش بودند، اما واقعاً آرزو می‌کردم آن زمان ابزارها و منابعی مثل امروز وجود داشت. به‌ویژه، پشتیبانی از async و await در زبان‌های مدرن .NET واقعاً طلاست.

اما اگر امروز به کتاب‌ها و منابع یادگیری همزمانی نگاه کنید، تقریباً همه از مفاهیم سطح بسیار پایین شروع می‌کنند. پوشش فوق‌العاده‌ای برای تردها و ساز و کارهای همزمانی سطح پایین وجود دارد و تکنیک‌های سطح بالاتر را یا دیرتر معرفی می‌کنند یا اصلاً نمی‌گویند. فکر می‌کنم این دو دلیل دارد: اول، بسیاری از توسعه‌دهندگانِ همزمانی (از جمله خودم) اول مفاهیم سطح پایین را یاد گرفتند و از تکنیک‌های قدیمی گذر کردند. دوم، بسیاری از کتاب‌ها سال‌ها پیش نوشته شده‌اند و تکنیک‌های مدرن‌تر بعداً به آن‌ها افزوده شده، اما متأسفانه در انتهای کتاب جای گرفته‌اند.

فکر می‌کنم این کار اشتباه است. در واقع، این کتاب فقط رویکردهای مدرن همزمانی را پوشش می‌دهد. این یعنی درک مفاهیم سطح‌پایین بی‌ارزش نیست ـ وقتی در دانشگاه بودم یاد گرفتم چطور با چند گیت، یک CPU مجازی بسازم، و در کلاسی دیگر اسمبلی خواندم. هرچند در کار حرفه‌ای‌ام هیچ‌گاه CPU نساخته‌ام و شاید فقط چند ده خط اسمبلی نوشته‌ام، اما همین بنیان فهم هر روز کمکم می‌کند. با این حال، باید یادگیری را از انتزاع‌های سطح بالاتر شروع کنیم؛ اولین کلاس برنامه‌نویسی من هم اسمبلی نبود!

این کتاب خلائی را پر می‌کند: مقدمه‌ای (و مرجعی) برای همزمانی با رویکردهای مدرن است. انواع مختلف همزمانی، شامل برنامه‌نویسی موازی، ناهمگام، و واکنش‌گرا را پوشش می‌دهد. البته، روش‌های قدیمی را اصلاً مطرح نمی‌کند، چون کتاب‌ها و منابع آنلاین زیادی برای آن‌ها وجود دارد.

---

## راهنمای استفاده از کتاب

ساختار کتاب به این صورت است:

- **فصل ۱:** مقدمه‌ای بر انواع همزمانی پوشش داده‌شده: موازی، ناهمگام، واکنش‌گرا و جریان داده  
- **فصل‌های ۲ تا ۶:** معرفی جامع‌تر این انواع همزمانی  
- **فصل‌های بعدی:** هرکدام به جنبه‌ای خاص از همزمانی می‌پردازند و به عنوان مرجعی برای حل مسائل متداول عمل می‌کنند  

توصیه می‌کنم حداقل فصل اول را حتی اگر با برخی از انواع همزمانی آشنا هستید، بخوانید یا مرور کنید.

> **هشدار:**  
> هنگام چاپ این کتاب، نسخه .NET Core 3.0 هنوز در وضعیت بتا قرار داشته، پس برخی جزییات مربوط به جریان‌های ناهمگام ممکن است تغییر کند.

---

## منابع آنلاین

این کتاب مانند یک مقدمه‌ی جامع برای انواع مختلفی از همزمانی عمل می‌کند. تمام تلاشم را کرده‌ام تا تکنیک‌هایی را پوشش دهم که خودم و دیگران آن‌ها را مفیدترین قلمداد کرده‌اند، اما به هیچ وجه این کتاب کامل و جامع نیست. در ادامه، بهترین منابعی را که برای آشنایی بیشتر با این فناوری‌ها یافته‌ام، معرفی می‌کنم:

- **برنامه‌نویسی موازی (Parallel Programming):** بهترین منبعی که می‌شناسم کتاب Parallel Programming with Microsoft .NET از انتشارات Microsoft Press است که متن آن به‌صورت آنلاین در دسترس می‌باشد. متأسفانه این کتاب کمی قدیمی شده است. بخش مربوط به futures بهتر است با کد ناهمگام جایگزین شود و بخش مربوط به pipelines باید از Channels یا TPL Dataflow استفاده کند.
- **برنامه‌نویسی ناهمگام (Asynchronous Programming):** سایت MSDN مرجع خیلی خوبی است، به‌خصوص بخش معرفی "Asynchronous Programming". همچنین، مایکروسافت مستندات مربوط به TPL Dataflow را هم منتشر کرده است.
- **System.Reactive (Rx):** این کتابخانه به سرعت در حال محبوب شدن در فضای آنلاین است و همچنان تکامل می‌یابد. به نظر من، بهترین منبع فعلی برای Rx کتاب الکترونیکی Introduction to Rx نوشته Lee Campbell است.

---

## سپاسگزاری‌ها

واقعیت این است که این کتاب بدون کمک افراد زیادی اصلاً شکل نمی‌گرفت!  
قبل از هر چیز، می‌خواهم از خداوند و منجی‌ام، عیسی مسیح تشکر کنم. مسیحی شدن مهم‌ترین تصمیم زندگی‌ام بود! اگر در این باره علاقه به دانستن بیشتر دارید، می‌توانید از طریق صفحه شخصی‌ام با من تماس بگیرید.

در مرتبه دوم، از خانواده‌ام سپاس‌گزارم که اجازه دادند تا این حد وقت کمتری کنارشان باشم. زمانی که نوشتن را شروع کردم، چند نفر از دوستان نویسنده‌ام به شوخی گفتند: «تا سال آینده از خانواده‌ات خداحافظی کن!» و من فکر می‌کردم شوخی می‌کنند. همسرم، مندی، و فرزندانمان، اس‌دی و اِما، درک و همراهی زیادی نشان دادند، در حالی که من روزها سر کار بودم و عصرها و آخر هفته‌ها می‌نوشتم. واقعاً از شما متشکرم. دوستتان دارم!

بدیهی است که این کتاب بدون حضور ویراستاران و بازبینان فنی ما، تا این حد خوب نمی‌شد: **استیون تاب**، **پتر اوندرکا** ("svick"), **نیک پالدی‌نو** ("casperOne"), **لی کمپبل** و **پدرو فلیکس**. پس اگر احیاناً ایرادی باقی مانده، کاملاً تقصیر آن‌هاست! فقط شوخی می‌کنم ـ نظرها و بازخوردهایشان در شکل‌دهی (و اصلاح) محتوا بسیار ارزشمند بود و مسئولیت هر اشتباه باقی‌مانده کاملاً با من است.

از **استیون تاب** به طور ویژه تشکر می‌کنم که "ترفند آرگومان بولی" (دستور 14.5) و شمار زیادی از موضوعات async را به من آموخت؛ و همچنین از **لی کمپبل** که به من یاد داد چگونه با System.Reactive کار کنم و کد observable ام را به روال بهتر و رایج‌تر بنویسم.

در پایان، از کسانی که این تکنیک‌ها را از ایشان آموخته‌ام تشکر می‌کنم: استیون تاب، لوچیان ویشیک، توماس لِوِسک، لی کمپبل، اعضای Stack Overflow و انجمن‌های MSDN، و شرکت‌کنندگان کنفرانس‌های نرم‌افزاری در میشیگان و اطرافش. بودن در جامعه توسعه نرم‌افزار را ارج می‌نهم و اگر این کتاب ارزش افزوده‌ای دارد، به خاطر راهی است که دیگران پیش‌تر نشان داده‌اند. از همه شما سپاسگزارم!

</div>

